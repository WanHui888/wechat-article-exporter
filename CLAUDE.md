# å¾®ä¿¡å…¬ä¼—å·ä¸‹è½½å™¨ - Claude Code å·¥ä½œè®°å½•

> **é¡¹ç›®**: WeChat Article Exporter V3
> **è·¯å¾„**: `C:\Tare\å¾®ä¿¡å…¬ä¼—å·ä¸‹è½½\wechat-article-exporter-v3`
> **æœ€åæ›´æ–°**: 2025-02-XX
> **å½“å‰é˜¶æ®µ**: TDD æµ‹è¯•å¼€å‘ - ä¸‹è½½å¼•æ“å·²å®Œæˆ

---

## ğŸ¯ å¿«é€Ÿæ¢å¤æŒ‡ä»¤

ä¸‹æ¬¡å¯åŠ¨æ—¶ï¼Œç›´æ¥è¯´ï¼š

```
è¯·ç»§ç»­ä»»åŠ¡#26ï¼Œåˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç›¸å…³çš„æµ‹è¯•
```

æˆ–è€…ï¼š

```
æ˜¾ç¤ºå½“å‰ä»»åŠ¡åˆ—è¡¨å’Œè¿›åº¦
```

---

## âœ… å·²å®Œæˆå·¥ä½œæ€»ç»“

### 1. ä¸‹è½½å¼•æ“æµ‹è¯•å¥—ä»¶ï¼ˆ111ä¸ªæµ‹è¯•å…¨éƒ¨ï¿½ï¿½ï¿½è¿‡ âœ…ï¼‰

#### æµ‹è¯•æ–‡ä»¶çŠ¶æ€ï¼š
- âœ… `tests/unit/download-helpers.test.ts` - 52/52 é€šè¿‡ (90ms)
- âœ… `tests/unit/download-article.test.ts` - 36/36 é€šè¿‡ (3.3s)
- âœ… `tests/unit/download-batch.test.ts` - 23/23 é€šè¿‡ (39.3s)

#### æµ‹è¯•è¦†ç›–èŒƒå›´ï¼š

**è¾…åŠ©å‡½æ•°æµ‹è¯• (52ä¸ª)**
- `isWeChatCdnUrl()` - å¾®ä¿¡CDNåŸŸåæ£€æµ‹
- `hashUrl()` - URLå“ˆå¸Œç”Ÿæˆï¼ˆMD5å‰16ä½ï¼‰
- `guessExtension()` - æ–‡ä»¶æ‰©å±•åæ™ºèƒ½çŒœæµ‹
- `extractImageUrls()` - HTMLå›¾ç‰‡URLæå–ï¼ˆæ”¯æŒsrc/data-src/background-imageï¼‰
- `replaceImageUrls()` - å›¾ç‰‡URLæœ¬åœ°åŒ–æ›¿æ¢

**å•ç¯‡ä¸‹è½½æµ‹è¯• (36ä¸ª)**
- ç¼“å­˜æ£€æŸ¥ï¼ˆå·²ä¸‹è½½æ–‡ç« è·³è¿‡ï¼‰
- å­˜å‚¨é…é¢éªŒè¯ï¼ˆ2MBä¼°ç®—ï¼‰
- HTMLè·å–ä¸é”™è¯¯å¤„ç†
- æ ‡é¢˜æå–ï¼ˆmsg_title â†’ og:title â†’ titleï¼‰
- CommentIdæå–
- å›¾ç‰‡ä¸‹è½½ä¸é”™è¯¯å¤„ç†
- æ–‡ä»¶ä¿å­˜ä¸æ•°æ®åº“è®°å½•
- å­˜å‚¨ä½¿ç”¨é‡æ›´æ–°

**æ‰¹é‡ä¸‹è½½æµ‹è¯• (23ä¸ª)**
- åŸºç¡€åŠŸèƒ½éªŒè¯
- ç¼“å­˜è·³è¿‡é€»è¾‘
- å¹¶å‘æ§åˆ¶ï¼ˆé»˜è®¤2ï¼ŒèŒƒå›´1-3ï¼‰
- é”™è¯¯å¤„ç†ï¼ˆç½‘ç»œã€é…é¢ã€éƒ¨åˆ†å¤±è´¥ï¼‰
- ç™»å½•è¿‡æœŸæ£€æµ‹ï¼ˆWeChatExpiredErrorï¼‰
- é€Ÿç‡é™åˆ¶ï¼ˆ500msé—´éš”ï¼‰
- è¾¹ç•Œæ¡ä»¶ï¼ˆå•ç¯‡ã€å¤§æ‰¹é‡ã€æ··åˆç¼“å­˜ï¼‰

### 2. æ€§èƒ½ä¼˜åŒ–ä»£ç åˆ†æ

å·²è¯»å–å¹¶åˆ†æçš„æ–‡ä»¶ï¼š
- `server/middleware/compression.ts` - å“åº”å‹ç¼©ï¼ˆGzip/Brotliï¼‰
- `server/utils/performance/image-optimizer.ts` - å›¾ç‰‡ä¼˜åŒ–å™¨
- `server/utils/performance/query-optimizer.ts` - æŸ¥è¯¢ä¼˜åŒ–å™¨

---

## ğŸ“‹ å½“å‰ä»»åŠ¡åˆ—è¡¨

### è¿›è¡Œä¸­
- **#26** - æ·»åŠ æ€§èƒ½ä¼˜åŒ– [in_progress]
  - âœ… å·²è¯»å–æ€§èƒ½ä¼˜åŒ–ç›¸å…³ä»£ç 
  - â³ å¾…åˆ›å»ºå‹ç¼©ä¸­é—´ä»¶æµ‹è¯•
  - â³ å¾…åˆ›å»ºå›¾ç‰‡ä¼˜åŒ–å™¨æµ‹è¯•
  - â³ å¾…åˆ›å»ºæŸ¥è¯¢ä¼˜åŒ–å™¨æµ‹è¯•

### å¾…åŠ
- **#27** - è¡¥å……å…¶ä»–åŠŸèƒ½æ¨¡å— [pending]
- **#28** - ä¼˜åŒ–ç°æœ‰ä»£ç  [pending]

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’

### ä¼˜å…ˆçº§1: å®Œæˆæ€§èƒ½ä¼˜åŒ–æµ‹è¯•

#### 1. å‹ç¼©ä¸­é—´ä»¶æµ‹è¯•
**æ–‡ä»¶**: `tests/unit/compression-middleware.test.ts`
**æµ‹è¯•ç‚¹**:
- Gzipå‹ç¼©åŠŸèƒ½
- Brotliå‹ç¼©åŠŸèƒ½
- å‹ç¼©çº§åˆ«é…ç½®ï¼ˆ1-9ï¼‰
- æœ€å°å‹ç¼©é˜ˆå€¼ï¼ˆé»˜è®¤1KBï¼‰
- MIMEç±»å‹è¿‡æ»¤
- è·¯å¾„æ’é™¤è§„åˆ™
- Accept-Encodingåå•†
- å‹ç¼©ç»Ÿè®¡æ•°æ®

#### 2. å›¾ç‰‡ä¼˜åŒ–å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/unit/image-optimizer.test.ts`
**æµ‹è¯•ç‚¹**:
- å›¾ç‰‡å‹ç¼©ä¸è´¨é‡æ§åˆ¶
- æ ¼å¼è½¬æ¢ï¼ˆJPEG/PNG/WebP/AVIFï¼‰
- å°ºå¯¸è°ƒæ•´ä¸å®½é«˜æ¯”
- å“åº”å¼å›¾ç‰‡ç”Ÿæˆ
- WebPè½¬æ¢
- ç¼©ç•¥å›¾ç”Ÿæˆ
- æ‰¹é‡ä¼˜åŒ–
- å…ƒæ•°æ®æå–
- æ‡’åŠ è½½å ä½ç¬¦ï¼ˆLQIPï¼‰

#### 3. æŸ¥è¯¢ä¼˜åŒ–å™¨æµ‹è¯•
**æ–‡ä»¶**: `tests/unit/query-optimizer.test.ts`
**æµ‹è¯•ç‚¹**:
- æŸ¥è¯¢ç¼“å­˜æœºåˆ¶
- æ‰¹é‡æŸ¥è¯¢åˆå¹¶
- æ€§èƒ½åˆ†æè®°å½•
- N+1æŸ¥è¯¢æ£€æµ‹
- åˆ†é¡µä¼˜åŒ–
- ç¼“å­˜å¤±æ•ˆç­–ç•¥

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç»†èŠ‚

### ä¸‹è½½å¼•æ“æ ¸å¿ƒé€»è¾‘

**å•ç¯‡ä¸‹è½½æµç¨‹**:
1. æ£€æŸ¥ç¼“å­˜ï¼ˆ`HtmlService.getHtml()`ï¼‰
2. éªŒè¯å­˜å‚¨é…é¢ï¼ˆé¢„ä¼°2MBï¼‰
3. è·å–æ–‡ç« HTML
4. æå–æ ‡é¢˜ï¼ˆä¼˜å…ˆçº§ï¼šmsg_title > og:title > titleï¼‰
5. æå–è¯„è®ºIDï¼ˆcomment_idå˜é‡ï¼‰
6. æå–å›¾ç‰‡URLsï¼ˆä»…WeChat CDNï¼‰
7. ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°
8. æ›¿æ¢HTMLä¸­çš„å›¾ç‰‡URL
9. ä¿å­˜æ–‡ä»¶å’Œæ•°æ®åº“è®°å½•
10. æ›´æ–°å­˜å‚¨ä½¿ç”¨é‡

**æ‰¹é‡ï¿½ï¿½è½½ç‰¹æ€§**:
- é»˜è®¤å¹¶å‘: 2ï¼ˆå¯é…ç½®1-3ï¼‰
- é€Ÿç‡é™åˆ¶: 500mså¯åŠ¨é—´éš”
- ç™»å½•è¿‡æœŸ: æ£€æµ‹åˆ°WeChatExpiredErroræ—¶åœæ­¢æ‰€æœ‰ä»»åŠ¡
- æ™ºèƒ½è·³è¿‡: è‡ªåŠ¨è¿‡æ»¤å·²ä¸‹è½½æ–‡ç« 

**å›¾ç‰‡å¤„ç†**:
- CDNåŸŸå: `mmbiz.qpic.cn`, `mmbiz.qlogo.cn`ï¼ˆå«å­åŸŸåï¼‰
- URLå“ˆå¸Œ: MD5çš„å‰16ä½ï¼ˆé¿å…æ–‡ä»¶åå†²çªï¼‰
- æ ¼å¼æ£€æµ‹é¡ºåº: Content-Type â†’ wx_fmtå‚æ•° â†’ URLæ‰©å±•å â†’ é»˜è®¤jpg

### æµ‹è¯•ç­–ç•¥

**Mockæ¶æ„**:
```typescript
// å…±äº«Mockå®ä¾‹ï¼ˆæ¨¡å—é¡¶å±‚å®šä¹‰ï¼‰
const mockFileService = {
  checkQuota: vi.fn().mockResolvedValue(true),
  getUploadPath: vi.fn((userId, fakeid, type) => `path/to/${type}`),
  saveFile: vi.fn().mockResolvedValue(1000),
  updateStorageUsed: vi.fn().mockResolvedValue(undefined),
}

const mockHtmlService = {
  getHtml: vi.fn().mockResolvedValue(null),
  saveHtml: vi.fn().mockResolvedValue(undefined),
  getDownloadedUrls: vi.fn().mockResolvedValue([]),
}

const mockResourceService = {
  getResource: vi.fn().mockResolvedValue(null),
  saveResource: vi.fn().mockResolvedValue(undefined),
  saveResourceMap: vi.fn().mockResolvedValue(undefined),
}
```

**æµ‹è¯•è¾…åŠ©å·¥å…·**:
- `tests/helpers/mock-responses.ts` - HTTPå“åº”Mock
  - `createMockHtmlResponse(html: string)`
  - `createMockImageResponse(size: number, contentType: string)`
  - `createMockErrorResponse(status: number, statusText: string)`

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

| æµ‹è¯•å¥—ä»¶ | æµ‹è¯•æ•° | çŠ¶æ€ | è€—æ—¶ |
|---------|--------|------|------|
| download-helpers | 52 | âœ… PASS | 90ms |
| download-article | 36 | âœ… PASS | 3.3s |
| download-batch | 23 | âœ… PASS | 39.3s |
| **æ€»è®¡** | **111** | **âœ… 100%** | **42.7s** |

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test -- tests/unit/download-helpers.test.ts
npm test -- tests/unit/download-article.test.ts
npm test -- tests/unit/download-batch.test.ts

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
npm run test:coverage
```

### é¡¹ç›®ç»“æ„
```
wechat-article-exporter-v3/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ download.service.ts        # ä¸‹è½½å¼•æ“ï¼ˆå·²æµ‹è¯•ï¼‰
â”‚   â”‚   â”œâ”€â”€ file.service.ts            # æ–‡ä»¶æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ html.service.ts            # HTMLæœåŠ¡
â”‚   â”‚   â””â”€â”€ resource.service.ts        # èµ„æºæœåŠ¡
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ compression.ts             # å‹ç¼©ä¸­é—´ä»¶ï¼ˆå¾…æµ‹è¯•ï¼‰
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ performance/
â”‚           â”œâ”€â”€ image-optimizer.ts     # å›¾ç‰‡ä¼˜åŒ–å™¨ï¼ˆå¾…æµ‹è¯•ï¼‰
â”‚           â””â”€â”€ query-optimizer.ts     # æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ˆå¾…æµ‹è¯•ï¼‰
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ download-helpers.test.ts   âœ… 52 passed
â”‚   â”‚   â”œâ”€â”€ download-article.test.ts   âœ… 36 passed
â”‚   â”‚   â””â”€â”€ download-batch.test.ts     âœ… 23 passed
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â””â”€â”€ mock-responses.ts          # Mockå·¥å…·
â”‚   â””â”€â”€ setup/
â”‚       â””â”€â”€ test-env.ts                # æµ‹è¯•ç¯å¢ƒ
â””â”€â”€ .env.test                          # æµ‹è¯•ç¯å¢ƒå˜é‡
```

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### 1. TDDæœ€ä½³å®è·µ
- âœ… å…ˆå†™æµ‹è¯•ï¼Œåå†™å®ç°ï¼ˆæœ¬é¡¹ç›®å®ç°å·²å­˜åœ¨ï¼Œè¡¥å……æµ‹è¯•ï¼‰
- âœ… æµ‹è¯•éš”ç¦»ï¼šæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ï¼Œä½¿ç”¨`beforeEach`æ¸…ç†çŠ¶æ€
- âœ… Mockå¤–éƒ¨ä¾èµ–ï¼šæ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œè¯·æ±‚å…¨éƒ¨Mock
- âœ… è¦†ç›–è¾¹ç•Œæ¡ä»¶ï¼šç©ºå€¼ã€é”™è¯¯ã€å¤§æ‰¹é‡ã€å¹¶å‘ç­‰

### 2. å¼‚æ­¥æµ‹è¯•æŠ€å·§
- ä½¿ç”¨`async/await`ç¡®ä¿å¼‚æ­¥æ“ä½œå®Œæˆ
- Mockå¼‚æ­¥å‡½æ•°ç”¨`mockResolvedValue`å’Œ`mockRejectedValue`
- æµ‹è¯•è¶…æ—¶/é‡è¯•é€»è¾‘æ—¶æ§åˆ¶æ—¶é—´ï¼ˆå¦‚æ‰¹é‡ä¸‹è½½çš„500mså»¶è¿Ÿï¼‰

### 3. Mockç­–ç•¥
- å…±äº«Mockå®ä¾‹ï¼ˆæ¨¡å—é¡¶å±‚å®šä¹‰ï¼‰é¿å…é‡å¤åˆ›å»º
- ä½¿ç”¨`vi.clearAllMocks()`æ¸…ç†è°ƒç”¨è®°å½•
- å…è®¸å…·ä½“æµ‹è¯•è¦†ç›–é»˜è®¤è¿”å›å€¼

---

## ğŸš¨ é‡è¦æé†’

### æµ‹è¯•ç¯å¢ƒé…ç½®
- ä½¿ç”¨`.env.test`é…ç½®ï¼ˆè‡ªåŠ¨åŠ è½½ï¼‰
- æµ‹è¯•æ•°æ®è‡ªåŠ¨æ¸…ç†ï¼ˆ`beforeEach`/`afterEach`ï¼‰
- ä¸è¦åœ¨æµ‹è¯•ä¸­ä¾èµ–çœŸå®çš„æ•°æ®åº“æˆ–æ–‡ä»¶ç³»ç»Ÿ

### Hooké…ç½®è¯´æ˜
é¡¹ç›®é…ç½®äº†ä¸¥æ ¼çš„æ–‡ä»¶åˆ›å»ºHookï¼š
- âœ… å…è®¸: README.md, CLAUDE.md, AGENTS.md, CONTRIBUTING.md, DEPLOY.md
- âŒ é˜»æ­¢: å…¶ä»–.md/.txtæ–‡æ¡£æ–‡ä»¶
- **åŸå› **: é¿å…åˆ›å»ºä¸å¿…è¦çš„æ–‡æ¡£æ–‡ä»¶

### ä¸‹æ¬¡å¯åŠ¨æ—¶
1. æŸ¥çœ‹æœ¬æ–‡ä»¶äº†è§£è¿›åº¦
2. è¿è¡Œæµ‹è¯•éªŒè¯ç¯å¢ƒï¼š`npm test -- tests/unit/download-helpers.test.ts`
3. ç»§ç»­ä»»åŠ¡#26ï¼šåˆ›å»ºæ€§èƒ½ä¼˜åŒ–æµ‹è¯•

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

ç›´æ¥å‘Claudeè¯´ï¼š
- "æ˜¾ç¤ºå½“å‰ä»»åŠ¡åˆ—è¡¨"
- "ç»§ç»­ä»»åŠ¡#26"
- "åˆ›å»ºå‹ç¼©ä¸­é—´ä»¶æµ‹è¯•"
- "è¿è¡Œæ‰€æœ‰ä¸‹è½½å¼•æ“æµ‹è¯•"

---

**æœ€åæ›´æ–°**: Session from 2025-02-XX
**ä¸‹æ¬¡ç›®æ ‡**: å®Œæˆæ€§èƒ½ä¼˜åŒ–æµ‹è¯•ï¼ˆå‹ç¼©ã€å›¾ç‰‡ã€æŸ¥è¯¢ï¼‰
